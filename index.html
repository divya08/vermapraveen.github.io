<!DOCTYPE html>
	<html lang="en">	
	<head>
		<title>Markdown-to-HTML Sample</title>
		<link rel="stylesheet" type="text/css" href="lib/css/bootstrap.min.css"/>
		<script type="text/javascript" src="lib/js/showdown.min.js"></script>
	</head>
	<body style="margin: 10px">
		<div id="data-markdown">
		</div>
	
		<script type="text/javascript">
			window.onload=function(){
				// this function is the reverse version of escapeHTML found at 
				// https://github.com/evilstreak/markdown-js/blob/master/src/render_tree.js
				function unescapeHTML( text ) {
				    return text.replace( /&amp;/g, "&" )
				               .replace( /&lt;/g, "<" )
				               .replace( /&gt;/g, ">" )
				               .replace( /&quot;/g, "\"" )
				               .replace( /&#39;/g, "'" );
				  }

				// //based on https://gist.github.com/paulirish/1343518
				// (function(){
				// 	fetch("content/posts/first.md")
				// 		.then(response => response.text())
				// 		.then(text => {
				// 			var elementToDisplay = document.querySelector('[data-markdown]');
				// 			elementToDisplay.innerHTML = (new Showdown.converter()).makeHtml(unescapeHTML(text))
				// 		});
				// }());

				function applyFirstStyle(rawMdText) {
					var divToAdd = document.createElement("DIV");
					divToAdd.innerHTML = rawMdText;
					var metadataElement = divToAdd.firstElementChild.nextElementSibling;
					var postMeta = JSON.parse(metadataElement.innerText);

					if(postMeta)
					{
						if(postMeta.date)
						{
							var divToAdd = document.createElement("DIV");
							divToAdd.setAttribute("id", "dateofPost");
							divToAdd.innerHTML=postMeta.date;
						}
					}
				}

				(function(){
					fetch("content/posts.json")
						.then(response => response.text())
						.then(text => {
							var actual_JSON = JSON.parse(text);

							var showdn = new Showdown.converter();
							var elementToDisplay = document.getElementById('data-markdown');

							actual_JSON.forEach(function(obj) {	
								fetch(obj.path)
									.then(contentResponse => contentResponse.text())
									.then(contentText => {
										var mdText = showdn.makeHtml(unescapeHTML(contentText));
										//applyFirstStyle(mdText);										
										var divToAdd = document.createElement("DIV");
										divToAdd.innerHTML = mdText;

										var metadataElement = divToAdd.firstElementChild.nextElementSibling;
										var postMeta = JSON.parse(metadataElement.innerText);

										if(postMeta)
										{
											if(postMeta.date)
											{
												var dateDivToAdd = document.createElement("DIV");
												dateDivToAdd.setAttribute("id", "blogCreationDate");
												dateDivToAdd.innerHTML=postMeta.date;
												divToAdd.appendChild(dateDivToAdd);
											}

											if(postMeta.title)
											{
												var titleDivToAdd = document.createElement("DIV");
												titleDivToAdd.setAttribute("id", "blogTitle");
												titleDivToAdd.innerHTML=postMeta.title;
												divToAdd.appendChild(titleDivToAdd);
											}

											if(postMeta.thumbnail)
											{
												var thumbnailDivToAdd = document.createElement("IMG");
												thumbnailDivToAdd.setAttribute("id", "blogThumbnail");
												thumbnailDivToAdd.setAttribute("src", postMeta.thumbnail);
												
												divToAdd.appendChild(thumbnailDivToAdd);
											}

											if(postMeta.tags)
											{
												var tagListToAdd = document.createElement("UL");
												tagListToAdd.setAttribute("id", "blogTags");

												postMeta.tags.forEach(function(aTagData) {	
													var tagToAdd = document.createElement("LI");
													var tagText = document.createTextNode(aTagData);
													tagToAdd.appendChild(tagText);
													tagListToAdd.appendChild(tagToAdd);
												});
												
												divToAdd.appendChild(tagListToAdd);
											}
										}

										metadataElement.style.display = 'none';
										elementToDisplay.appendChild(divToAdd);										
								});

								console.log(obj.path);					
							});
						});
				}());

				(function(){
					
				}());
			}
		</script>
	</body>
</html>                                		